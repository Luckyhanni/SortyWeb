@page "/runner"
@inject OrderService OrderService
@inject DiscordService DiscordService
@rendermode InteractiveServer

<div class="container-fluid mt-3 px-3" style="max-width: 850px;">

    <div class="row g-2 mb-3">
        <div class="col-6 col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm p-2 d-flex flex-column align-items-center justify-content-center bg-dark text-white h-100" style="min-height: 70px;">
                <small class="text-white-50 text-uppercase fw-bold" style="font-size: 0.65rem;">Gesamt</small>
                <span class="fs-4 fw-bold lh-1">@stats.Values.Sum()</span>
            </div>
        </div>

        @foreach (var wh in warehouses)
        {
            var count = stats.ContainsKey(wh.Name) ? stats[wh.Name] : 0;
            <div class="col-6 col-sm-4 col-md-3">
                <div class="card border-0 shadow-sm p-2 d-flex flex-column align-items-center justify-content-center h-100"
                     style="background-color: white; min-height: 70px; border-left: 4px solid @wh.ColorHex !important;">
                    <span class="text-muted fw-bold text-truncate w-100 text-center" style="font-size: 0.8rem;">@wh.Name</span>
                    <span class="fs-4 fw-bold lh-1 text-dark">@count</span>
                </div>
            </div>
        }
    </div>

    <div class="d-flex gap-2 mb-3 overflow-auto pb-1" style="scrollbar-width: none;">
        <button class="btn btn-sm rounded-pill px-3 fw-bold @(filterDate == null ? "btn-dark" : "btn-light border")"
                @onclick="() => FilterByDate(null)">
            ALLE
        </button>
        <button class="btn btn-sm rounded-pill px-3 fw-bold @(IsDate(22) ? "btn-primary" : "btn-light border")"
                @onclick="() => FilterByDate(22)">
            22. Dez
        </button>
        <button class="btn btn-sm rounded-pill px-3 fw-bold @(IsDate(23) ? "btn-primary" : "btn-light border")"
                @onclick="() => FilterByDate(23)">
            23. Dez
        </button>
    </div>

    <div class="sticky-top pt-1 pb-3" style="background-color: var(--apple-bg); z-index: 90; margin-left: -10px; margin-right: -10px; padding-left: 10px; padding-right: 10px;">
        <div class="input-group input-group-lg shadow-sm" style="border-radius: 16px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); background-color: white;">
            <span class="input-group-text border-0 bg-transparent ps-3"><i class="bi bi-search text-secondary"></i></span>
            <input type="text" class="form-control border-0 bg-transparent" placeholder="Suchen..."
                   style="height: 55px; font-size: 1.2rem;"
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="Search" />
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button class="btn border-0 pe-3" @onclick="ClearSearch"><i class="bi bi-x-circle-fill text-muted fs-5"></i></button>
            }
        </div>
    </div>

    <div class="d-flex flex-column gap-3 pb-5">
        @if (filteredResults.Any())
        {
            @foreach (var result in filteredResults)
            {
                var item = result.Order;
                var wh = warehouses.FirstOrDefault(w => w.Name == item.Ort);
                var color = wh?.ColorHex ?? "#999";

                <div class="card border-0 shadow-sm overflow-hidden animate__animated animate__fadeInUp" style="border-radius: 18px;">
                    <div class="d-flex align-items-stretch">
                        <div style="width: 10px; background-color: @color;"></div>

                        <div class="p-3 flex-grow-1 d-flex flex-column justify-content-center">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h4 class="fw-bold m-0 text-dark text-truncate">@item.Name</h4>
                                <span class="badge bg-light text-dark border ms-2">@item.PickupDate.ToString("dd.MM.")</span>
                            </div>
                            <div class="text-muted fw-medium mb-2 small text-uppercase">@item.Vorname</div>

                            <div class="d-flex align-items-center">
                                <div class="badge rounded-pill me-2 px-2" style="background-color: @color; font-weight: 500; font-size: 0.8rem;">
                                    @item.Ort
                                </div>
                                <span class="ms-auto text-end" style="color: #333; line-height: 1;">
                                    <small class="text-muted text-uppercase" style="font-size: 0.6rem; display: block;">Kiste</small>
                                    <span class="fw-bold" style="font-size: 1.5rem;">#@item.ChestNumber</span>
                                </span>
                            </div>
                        </div>

                        <button class="btn btn-light rounded-0 border-start d-flex flex-column justify-content-center align-items-center px-3"
                                style="background-color: #fafafa;"
                                @onclick="() => Pickup(item)">
                            <i class="bi bi-box-seam fs-2 text-success mb-1"></i>
                            <span class="fw-bold text-success" style="font-size: 0.65rem; letter-spacing: 0.5px;">HOLEN</span>
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center mt-5 text-muted opacity-50">
                <p>Keine Bestellungen gefunden.</p>
            </div>
        }
    </div>
</div>

@code {
    private string searchTerm = "";
    private List<(Order Order, int Score)> searchResults = new();
    private List<Warehouse> warehouses = new();
    private Dictionary<string, int> stats = new();

    // Wir setzen den Filter beim Start auf den heutigen Tag (falls 22./23.), sonst null (alles)
    private int? filterDate = null;

    private IEnumerable<(Order Order, int Score)> filteredResults =>
        searchResults.Where(x => filterDate == null || x.Order.PickupDate.Day == filterDate);

    protected override async Task OnInitializedAsync()
    {
        // Wenn heute 22. oder 23. ist, setze Filter automatisch
        var today = DateTime.Now.Day;
        if (today == 22 || today == 23) filterDate = today;

        await LoadData();
        await LoadInitialList(); // Lädt alle beim Start
    }

    private async Task LoadData()
    {
        warehouses = await OrderService.GetWarehousesAsync();
        stats = await OrderService.GetFullStatsAsync();
    }

    private async Task LoadInitialList()
    {
        // Holt ALLE aktiven Bestellungen (sortiert nach Name)
        var all = await OrderService.GetActiveOrdersAsync();

        // Wir packen sie in die searchResults Struktur (Score = 100, da kein Suchbegriff)
        searchResults = all.Select(o => (o, 100)).ToList();
    }

    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await LoadInitialList(); // Zurücksetzen auf volle Liste
            return;
        }
        searchResults = await OrderService.SearchOrdersAsync(searchTerm);
    }

    private void ClearSearch()
    {
        searchTerm = "";
        _ = LoadInitialList(); // Fire and forget reload
    }

    private void FilterByDate(int? day)
    {
        filterDate = day;
    }

    private bool IsDate(int day) => filterDate == day;

    private async Task Pickup(Order order)
    {
        await OrderService.PickupOrderAsync(order.Id);

        // Aus lokaler Liste entfernen
        searchResults.RemoveAll(x => x.Order.Id == order.Id);

        await LoadData(); // Stats update

        _ = DiscordService.SendPickupNotificationAsync(
            order.Name, order.Vorname, order.ChestNumber, order.Ort, order.PickupDate
        );
    }
}